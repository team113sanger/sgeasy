% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/differential-analysis.R
\name{run_positional_differential_analysis}
\alias{run_positional_differential_analysis}
\title{Run position-aware DESeq2 differential analysis}
\usage{
run_positional_differential_analysis(
  count_matrix,
  normalization_matrix,
  sample_metadata,
  pos_effect_data,
  condition_levels = c("Day4", "Day7", "Day10", "Day15"),
  shrinkage_type = "normal",
  alpha = 0.05,
  include_rate = TRUE,
  sample_prefix = "count_"
)
}
\arguments{
\item{count_matrix}{Numeric matrix of variant counts with sequences as
row names and samples as columns.}

\item{normalization_matrix}{Matrix of neutral variants for size factor
estimation (e.g., synonymous/intronic variants).}

\item{sample_metadata}{Data frame with sample information. Must contain
\code{condition}, \code{duration}, and \code{supplier_name} columns.}

\item{pos_effect_data}{A data frame with at minimum \code{SEQUENCE} and
\code{pos_effect} columns (e.g., from \code{\link[=correct_position_effect]{correct_position_effect()}} after
renaming). The \code{pos_effect} values are the fitted positional biases
on the log2 scale.}

\item{condition_levels}{Character vector specifying condition factor levels
in order (default: c("Day4", "Day7", "Day10", "Day15")).}

\item{shrinkage_type}{Type of LFC shrinkage: "normal", "apeglm", or "ashr"
(default: "normal").}

\item{alpha}{Significance threshold for adjusted p-values (default: 0.05).}

\item{include_rate}{Logical; whether to include continuous rate analysis
(default: TRUE).}

\item{sample_prefix}{Prefix used for sample column names in the count matrix
(default: "count_"). Set to "" if column names match supplier_name directly.}
}
\value{
An \link{SGEResults} object, identical in structure to
\code{\link[=run_differential_analysis]{run_differential_analysis()}} output.
}
\description{
Wraps \code{\link[=run_differential_analysis]{run_differential_analysis()}} but incorporates position effects
as per-gene normalization factor offsets. This allows DESeq2's Wald tests
to account for positional bias in the count data.
}
\details{
The function modifies the standard DESeq2 pipeline by replacing scalar
size factors with a full normalization factor matrix:
\enumerate{
\item Computes base size factors from neutral variants (as usual)
\item Constructs a normalization matrix where
\code{norm[i,j] = size_factor[j] * 2^pos_effect[i]}
\item Sets \code{DESeq2::normalizationFactors(dds)} instead of
\code{sizeFactors(dds)}
\item Runs DESeq2 as normal â€” Wald tests now account for positional bias
}

Variants not found in \code{pos_effect_data} receive a positional offset of 0
(i.e., no correction). The downstream pipeline
(\code{\link[=recalculate_screen_statistics]{recalculate_screen_statistics()}}, \code{\link[=classify_all_contrasts]{classify_all_contrasts()}}, etc.)
works unchanged on the output.
}
\examples{
\dontrun{
pos_data <- calculate_position_effect(count_data, annotation, "Day4")
corrected <- correct_position_effect(pos_data)

# Prepare pos_effect_data with SEQUENCE and pos_effect columns
pos_effects <- corrected |>
  dplyr::select(SEQUENCE = Seq, pos_effect) |>
  dplyr::distinct()

results <- run_positional_differential_analysis(
  count_matrix = counts,
  normalization_matrix = norm_counts,
  sample_metadata = metadata,
  pos_effect_data = pos_effects
)
}

}
\seealso{
\code{\link[=run_differential_analysis]{run_differential_analysis()}}, \code{\link[=correct_position_effect]{correct_position_effect()}}
}
